<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.main.bank.BankMapper">
	
	<update id="updatePlanState">
		<![CDATA[
			UPDATE wego.plan
			SET state = 1
			WHERE plan_pk IN(SELECT a.plan_pk FROM (SELECT plan_pk FROM wego.plan WHERE state = 0 AND end_date < SYSDATE()) a);
		]]>
	</update>
	
	<insert id="insertBankPlanChk">
		INSERT INTO wego.bank_plan_chk(plan_pk)
		SELECT plan_pk
		FROM wego.plan WHERE NOT EXISTS(SELECT plan_pk FROM wego.bank_plan_chk) AND state = 1;
	</insert>
	
	<select id="selectEndPlan" resultType="kr.co.main.bank.BankPlanVO">
		SELECT *
		FROM wego.plan
		WHERE plan_pk IN(SELECT plan_pk FROM wego.bank_plan_chk WHERE account_insert = 0);
	</select>
	
	<select id="selectAccountNeedPlanDetail" parameterType="int" resultType="kr.co.main.bank.BankPlanDetailVO">
		SELECT d.start_time, d.end_time, d. budget, d.plan_pk, l.location_name, l.address
		FROM wego.plan_detail d, wego.location l
		WHERE d.location_pk = l.location_pk
		  AND plan_pk = #{plan_pk}
		ORDER BY plan_pk, start_time;
	</select>
	
</mapper>